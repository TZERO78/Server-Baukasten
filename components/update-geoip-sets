#!/bin/bash
################################################################################
# GEOIP SET UPDATER v3.1 - ROBUST, ATOMAR & SIMPLES CHUNKING
#
# @description: Kombiniert einfache Struktur mit robustem, atomarem Update.
#               Nutzt das bewÃ¤hrte 'split'-Chunking von v1.0.
# @author:      Markus F. (TZERO78) & KI-Assistenten
# @repository:  https://github.com/TZERO78/Server-Baukasten
################################################################################

set -euo pipefail

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
readonly VERSION="3.1.0"
readonly LOG_TAG="geoip-update"
readonly COUNTRIES_FILE="/etc/geoip-countries.conf"
readonly HOME_COUNTRY_FILE="/etc/geoip-home-country.conf"
readonly ALLOWLIST_FILE="/etc/geoip-allowlist.conf"
readonly CHUNK_SIZE=2000
readonly DOWNLOAD_TIMEOUT=60
readonly CONNECT_TIMEOUT=15
readonly NFT_CMD="/usr/sbin/nft"

# TemporÃ¤re Dateien (werden durch trap aufgerÃ¤umt)
TEMP_BLOCKED_V4=""
TEMP_BLOCKED_V6=""
TEMP_HOME_V4=""
TEMP_HOME_V6=""
TEMP_ALLOWLIST_V4=""
TEMP_ALLOWLIST_V6=""
NFT_COMMAND_FILE=""

# Farben
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; CYAN='\033[0;36m'; NC='\033[0m'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# AUFRÃ„UMEN & LOGGING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cleanup() {
    rm -f "$TEMP_BLOCKED_V4" "$TEMP_BLOCKED_V6" "$TEMP_HOME_V4" "$TEMP_HOME_V6" \
          "$TEMP_ALLOWLIST_V4" "$TEMP_ALLOWLIST_V6" "$NFT_COMMAND_FILE"
}
trap cleanup EXIT HUP INT TERM

##
# Loggt eine normale Info-Meldung.
##
log_info() {
    echo -e "${CYAN}[INFO]${NC} $*" >&2
    if command -v logger &>/dev/null; then
        logger -t "$LOG_TAG" -p "daemon.info" -- "$*"
    fi
}

##
# Loggt eine Erfolgs-Meldung.
##
log_ok() {
    echo -e "${GREEN}[OK]${NC} $*" >&2
    if command -v logger &>/dev/null; then
        logger -t "$LOG_TAG" -p "daemon.notice" -- "SUCCESS: $*"
    fi
}

##
# Loggt eine Warnung.
##
log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $*" >&2
    if command -v logger &>/dev/null; then
        logger -t "$LOG_TAG" -p "daemon.warning" -- "WARN: $*"
    fi
}

##
# Loggt einen kritischen Fehler.
##
log_error() {
    echo -e "${RED}[ERROR]${NC} $*" >&2
    if command -v logger &>/dev/null; then
        logger -t "$LOG_TAG" -p "daemon.err" -- "ERROR: $*"
    fi
}

##
# Loggt eine Debug-Meldung (nur wenn DEBUG=true).
##
log_debug() {
    if [ "${DEBUG:-false}" = "true" ]; then
        echo -e "${PURPLE}[DEBUG]${NC} $*" >&2
        if command -v logger &>/dev/null; then
            logger -t "$LOG_TAG" -p "daemon.debug" -- "DEBUG: $*"
        fi
    fi
}


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HELFER-FUNKTIONEN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

check_dependencies() {
    if ! command -v curl >/dev/null 2>&1; then
        log_error "Fehlende AbhÃ¤ngigkeit: curl. Bitte installieren."
        exit 1
    fi
    if [ ! -x "$NFT_CMD" ]; then
        log_error "nft-Befehl nicht gefunden oder nicht ausfÃ¼hrbar unter: $NFT_CMD"
        exit 1
    fi
}

download_countries_batch() {
    local countries="$1"
    local target_v4="$2"
    local target_v6="$3"
    
    log_info "Lade IP-Listen fÃ¼r: $countries"
    local temp_file; temp_file=$(mktemp)
    
    for country in $countries; do
        local country_lower; country_lower=$(echo "$country" | tr '[:upper:]' '[:lower:]')
        
        local url_v4="https://www.ipdeny.com/ipblocks/data/countries/${country_lower}.zone"
        if curl -Lsf --max-time "$DOWNLOAD_TIMEOUT" --connect-timeout "$CONNECT_TIMEOUT" -o "$temp_file" "$url_v4"; then
            cat "$temp_file" >> "$target_v4"
        else
            log_warn "IPv4-Download fÃ¼r $country fehlgeschlagen."
        fi

        local url_v6="https://www.ipdeny.com/ipv6/ipaddresses/blocks/${country_lower}.zone"
        if curl -Lsf --max-time "$DOWNLOAD_TIMEOUT" --connect-timeout "$CONNECT_TIMEOUT" -o "$temp_file" "$url_v6"; then
            cat "$temp_file" >> "$target_v6"
        fi
    done
    rm -f "$temp_file"
}

load_persistent_allowlist() {
    if [ ! -s "$ALLOWLIST_FILE" ]; then
        return 0
    fi
    log_info "Lade persistente Allowlist..."
    readarray -t lines < "$ALLOWLIST_FILE"
    for line in "${lines[@]}"; do
        [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
        line_clean=$(echo "$line" | xargs)
        if [[ "$line_clean" == *":"* ]]; then
            echo "$line_clean" >> "$TEMP_ALLOWLIST_V6"
        else
            echo "$line_clean" >> "$TEMP_ALLOWLIST_V4"
        fi
    done
}

build_nft_commands() {
    log_info "Erstelle atomaren Update-Plan..."
    
    # 1. Alle Sets leeren
    echo "flush set inet filter geoip_blocked_v4" >> "$NFT_COMMAND_FILE"
    echo "flush set inet filter geoip_blocked_v6" >> "$NFT_COMMAND_FILE"
    echo "flush set inet filter geoip_home_v4" >> "$NFT_COMMAND_FILE"
    echo "flush set inet filter geoip_home_v6" >> "$NFT_COMMAND_FILE"
    echo "flush set inet filter geoip_allowlist_v4" >> "$NFT_COMMAND_FILE"
    echo "flush set inet filter geoip_allowlist_v6" >> "$NFT_COMMAND_FILE"

    # 2. Funktion, um 'add element'-Befehle zu generieren (im Stil von v1.0)
    add_elements_to_plan() {
        local set_name="$1"
        local ip_file="$2"
        [ ! -s "$ip_file" ] && return
        
        local line_count
        line_count=$(wc -l < "$ip_file")

        if [ "$line_count" -gt "$CHUNK_SIZE" ]; then
            log_info "-> '$set_name' wird aufgeteilt ($line_count IPs > $CHUNK_SIZE Limit)..."
            local chunk_dir; chunk_dir=$(mktemp -d)
            split -l "$CHUNK_SIZE" "$ip_file" "$chunk_dir/chunk-"
            
            for chunk_file in "$chunk_dir"/chunk-*; do
                local ip_list; ip_list=$(paste -sd, "$chunk_file")
                [ -n "$ip_list" ] && echo "add element inet filter $set_name { $ip_list }" >> "$NFT_COMMAND_FILE"
            done

            rm -r "$chunk_dir"
        else
            local ip_list; ip_list=$(paste -sd, "$ip_file")
            [ -n "$ip_list" ] && echo "add element inet filter $set_name { $ip_list }" >> "$NFT_COMMAND_FILE"
        fi
    }

    # 3. Befehle fÃ¼r alle sechs Sets generieren
    add_elements_to_plan "geoip_blocked_v4" "$TEMP_BLOCKED_V4"
    add_elements_to_plan "geoip_blocked_v6" "$TEMP_BLOCKED_V6"
    add_elements_to_plan "geoip_home_v4" "$TEMP_HOME_V4"
    add_elements_to_plan "geoip_home_v6" "$TEMP_HOME_V6"
    add_elements_to_plan "geoip_allowlist_v4" "$TEMP_ALLOWLIST_V4"
    add_elements_to_plan "geoip_allowlist_v6" "$TEMP_ALLOWLIST_V6"
}


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HAUPTPROGRAMM
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

main() {
    log_info "ğŸŒ GeoIP Set-Update v$VERSION gestartet"
    check_dependencies
    
    local countries_to_block; countries_to_block=$(<"$COUNTRIES_FILE" xargs)
    local home_country; home_country=$(<"$HOME_COUNTRY_FILE" xargs)

    if [ -z "$countries_to_block" ] && [ -z "$home_country" ]; then
        log_warn "Keine LÃ¤nder konfiguriert. Update wird beendet."
        exit 0
    fi
    log_info "Blockierte LÃ¤nder: ${countries_to_block:-Keine}, Heimatland: ${home_country:-Nicht gesetzt}"

    TEMP_BLOCKED_V4=$(mktemp)
    TEMP_BLOCKED_V6=$(mktemp)
    TEMP_HOME_V4=$(mktemp)
    TEMP_HOME_V6=$(mktemp)
    TEMP_ALLOWLIST_V4=$(mktemp)
    TEMP_ALLOWLIST_V6=$(mktemp)
    NFT_COMMAND_FILE=$(mktemp)

    [ -n "$countries_to_block" ] && download_countries_batch "$countries_to_block" "$TEMP_BLOCKED_V4" "$TEMP_BLOCKED_V6"
    [ -n "$home_country" ] && download_countries_batch "$home_country" "$TEMP_HOME_V4" "$TEMP_HOME_V6"
    load_persistent_allowlist

    build_nft_commands
    
    log_info "FÃ¼hre atomares Update aus..."
    if sudo $NFT_CMD -f "$NFT_COMMAND_FILE"; then
        log_ok "GeoIP Set-Update erfolgreich abgeschlossen!"
        exit 0
    else
        log_error "Fehler beim AusfÃ¼hren des atomaren Updates!"
        log_error "Die Firewall wurde NICHT verÃ¤ndert."
        log_info "PrÃ¼fe die Befehlsdatei fÃ¼r Fehler: $NFT_COMMAND_FILE"
        exit 1
    fi
}

# Skript-Start
main "$@"