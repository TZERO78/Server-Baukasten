#!/bin/bash
################################################################################
# GEOIP MANAGEMENT TOOL v2.1 - STANDALONE
#
# @description: EigenstÃ¤ndiges Management-Tool fÃ¼r das Set-basierte GeoIP-Blocking
# @author:      Markus F. (TZERO78) & KI-Assistenten
# @repository:  https://github.com/TZERO78/Server-Baukasten
#
# ------------------------------------------------------------------------------
# Verwendung:
#   geoip-manager status                 - Zeigt Status und Statistiken
#   geoip-manager update                 - Startet manuelles Update
#   geoip-manager hits                   - Zeigt Traffic-Statistiken
#   geoip-manager test <IP>              - Testet IP-Behandlung
#   geoip-manager allow <IP>             - FÃ¼gt IP zur Allowlist hinzu
#   geoip-manager country list           - Zeigt LÃ¤nder-Konfiguration
#   geoip-manager country add <CODE>     - FÃ¼gt Land zur Blockliste hinzu
#   geoip-manager country remove <CODE>  - Entfernt Land von Blockliste
#   geoip-manager country home <CODE>    - Setzt Heimatland
#   geoip-manager logs [Anzahl]          - Zeigt Update-Logs
#   geoip-manager help                   - Zeigt ausfÃ¼hrliche Hilfe
################################################################################

set -eo pipefail

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KONFIGURATION & VARIABLEN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

readonly VERSION="2.1.0"
readonly COUNTRIES_FILE="/etc/geoip-countries.conf"
readonly HOME_COUNTRY_FILE="/etc/geoip-home-country.conf"
readonly ALLOWLIST_FILE="/etc/geoip-allowlist.conf"
readonly UPDATE_SCRIPT="/usr/local/bin/update-geoip-sets"
readonly LOG_TAG="geoip-manager"

# NFT-Befehl mit vollem Pfad (robuster)
readonly NFT_CMD="/usr/sbin/nft"

# Farben fÃ¼r bessere Lesbarkeit
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'
CYAN='\033[0;36m'; PURPLE='\033[0;35m'; NC='\033[0m'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LOGGING & HELPER-FUNKTIONEN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

##
# Loggt eine Informations-Meldung.
##
log_info() {
    echo -e "${CYAN}[INFO]${NC} $*" >&2
    if command -v logger &>/dev/null; then
        logger -t "$LOG_TAG" -p "daemon.info" -- "$*"
    fi
}

##
# Loggt eine Erfolgs-Meldung.
##
log_ok() {
    echo -e "${GREEN}[OK]${NC} $*" >&2
    if command -v logger &>/dev/null; then
        logger -t "$LOG_TAG" -p "daemon.notice" -- "SUCCESS: $*"
    fi
}

##
# Loggt eine Warnung.
##
log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $*" >&2
    if command -v logger &>/dev/null; then
        logger -t "$LOG_TAG" -p "daemon.warning" -- "WARN: $*"
    fi
}

##
# Loggt einen kritischen Fehler.
##
log_error() {
    echo -e "${RED}[ERROR]${NC} $*" >&2
    if command -v logger &>/dev/null; then
        logger -t "$LOG_TAG" -p "daemon.err" -- "ERROR: $*"
    fi
}

##
# Gibt einen formatierten Header aus.
##
print_header() {
    local title="$1"
    echo -e "\n${BLUE}=== $title ===${NC}"
}

##
# PrÃ¼ft, ob alle nÃ¶tigen AbhÃ¤ngigkeiten verfÃ¼gbar sind.
##
check_dependencies() {
    local missing_deps=()
    
    # PrÃ¼fe kritische Befehle
    for cmd in systemctl journalctl; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            missing_deps+=("$cmd")
        fi
    done
    
    # PrÃ¼fe NFT mit vollem Pfad
    if [ ! -x "$NFT_CMD" ]; then
        missing_deps+=("nft")
    fi
    
    if [ ${#missing_deps[@]} -gt 0 ]; then
        log_error "Fehlende AbhÃ¤ngigkeiten: ${missing_deps[*]}"
        log_error "Bitte installiere die fehlenden Pakete und versuche es erneut."
        exit 1
    fi
}

##
# PrÃ¼ft, ob das GeoIP-System korrekt installiert ist.
##
check_geoip_installation() {
    local missing_files=()
    
    # PrÃ¼fe Konfigurationsdateien
    [ ! -f "$COUNTRIES_FILE" ] && missing_files+=("$COUNTRIES_FILE")
    [ ! -f "$HOME_COUNTRY_FILE" ] && missing_files+=("$HOME_COUNTRY_FILE")
    [ ! -f "$UPDATE_SCRIPT" ] && missing_files+=("$UPDATE_SCRIPT")
    
    if [ ${#missing_files[@]} -gt 0 ]; then
        log_error "GeoIP-System nicht vollstÃ¤ndig installiert!"
        log_error "Fehlende Dateien: ${missing_files[*]}"
        log_info "FÃ¼hre zuerst den Server-Baukasten aus oder installiere die Komponenten manuell."
        exit 1
    fi
    
    # PrÃ¼fe NFTables-Integration
    if ! $NFT_CMD list chain inet filter geoip_check >/dev/null 2>&1; then
        log_error "GeoIP-Chain 'geoip_check' nicht gefunden!"
        log_error "Firewall-Integration fehlt oder ist beschÃ¤digt."
        exit 1
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KERN-FUNKTIONEN FÃœR GEOIP-MANAGEMENT (KORRIGIERT)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

##
# Erkennt den aktuellen Status der GeoIP-Chain (ROBUSTE VERSION).
##
detect_geoip_chain_status() {
    # 1. Chain existiert?
    if ! $NFT_CMD list chain inet filter geoip_check >/dev/null 2>&1; then
        echo "missing"
        return
    fi
    
    # 2. Integration prÃ¼fen Ã¼ber Handle-IDs
    local input_handles=$($NFT_CMD -a list chain inet filter input 2>/dev/null | grep "jump geoip_check" | grep -o "# handle [0-9]*")
    
    if [ -z "$input_handles" ]; then
        echo "unintegrated"
        return
    fi
    
    # 3. Sets prÃ¼fen (bleibt gleich)
    local stats=($(get_set_stats))
    local total_ips=$(( ${stats[0]:-0} + ${stats[1]:-0} + ${stats[2]:-0} + ${stats[3]:-0} ))
    
    [ "$total_ips" -gt 10 ] && echo "active" || echo "empty_sets"
}

##
# ZÃ¤hlt die IPs in allen GeoIP-Sets zuverlÃ¤ssig (KORRIGIERTE VERSION).
##
get_set_stats() {
    # IPv4-Sets: ZÃ¤hle Zeilen die mit Zahlen beginnen (mit tr -d fÃ¼r saubere Ausgabe)
    local home_v4=$($NFT_CMD list set inet filter geoip_home_v4 2>/dev/null | grep -c "^[[:space:]]*[0-9]" | tr -d '\n\r' || echo "0")
    local blocked_v4=$($NFT_CMD list set inet filter geoip_blocked_v4 2>/dev/null | grep -c "^[[:space:]]*[0-9]" | tr -d '\n\r' || echo "0")
    
    # IPv6-Sets: ZÃ¤hle Zeilen die :: enthalten (charakteristisch fÃ¼r IPv6)
    local home_v6=$($NFT_CMD list set inet filter geoip_home_v6 2>/dev/null | grep -c "::" | tr -d '\n\r' || echo "0")
    local blocked_v6=$($NFT_CMD list set inet filter geoip_blocked_v6 2>/dev/null | grep -c "::" | tr -d '\n\r' || echo "0")
    
    echo "$home_v4 $home_v6 $blocked_v4 $blocked_v6"
}

##
# Sammelt Konfigurationsdaten aus den Config-Dateien.
##
get_configuration() {
    local blocked_countries="Nicht konfiguriert"
    local home_country="Nicht gesetzt"
    
    if [ -f "$COUNTRIES_FILE" ] && [ -r "$COUNTRIES_FILE" ]; then
        blocked_countries=$(cat "$COUNTRIES_FILE" 2>/dev/null | tr -d '\n\r' || echo 'Lesefehler')
        # Entferne fÃ¼hrende/nachfolgende Leerzeichen
        blocked_countries=$(echo "$blocked_countries" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        [ -z "$blocked_countries" ] && blocked_countries="Leer"
    fi
    
    if [ -f "$HOME_COUNTRY_FILE" ] && [ -r "$HOME_COUNTRY_FILE" ]; then
        home_country=$(cat "$HOME_COUNTRY_FILE" 2>/dev/null | tr -d '\n\r' || echo 'Lesefehler')
        home_country=$(echo "$home_country" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        [ -z "$home_country" ] && home_country="Leer"
    fi
    
    echo "$blocked_countries|$home_country"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COUNTRY-MANAGEMENT-FUNKTIONEN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

##
# Zeigt die aktuelle LÃ¤nder-Konfiguration an.
##
show_country_config() {
    print_header "LÃ„NDER-KONFIGURATION"
    
    local config_data=$(get_configuration)
    local blocked_countries=$(echo "$config_data" | cut -d'|' -f1)
    local home_country=$(echo "$config_data" | cut -d'|' -f2)
    
    echo -e "${GREEN}Heimatland (geschÃ¼tzt):${NC}"
    echo -e "  $home_country"
    echo
    
    echo -e "${RED}Blockierte LÃ¤nder:${NC}"
    if [ "$blocked_countries" = "Nicht konfiguriert" ] || [ "$blocked_countries" = "Leer" ]; then
        echo -e "  ${YELLOW}âš ï¸  Keine LÃ¤nder blockiert${NC}"
    else
        # Formatiere LÃ¤nder-Liste schÃ¶n
        echo "$blocked_countries" | tr ',' '\n' | sed 's/^[[:space:]]*/  â€¢ /' | sed 's/[[:space:]]*$//'
    fi
    
    echo
    echo -e "${CYAN}VerfÃ¼gbare Aktionen:${NC}"
    echo -e "  geoip-manager country add <CODE>     - Land hinzufÃ¼gen"
    echo -e "  geoip-manager country remove <CODE>  - Land entfernen"
    echo -e "  geoip-manager country home <CODE>    - Heimatland setzen"
    
    # Zeige Set-Statistiken fÃ¼r Kontext
    local stats=($(get_set_stats))
    local blocked_v4=${stats[2]:-0}
    local blocked_v6=${stats[3]:-0}
    echo
    echo -e "${BLUE}Aktuelle Set-GrÃ¶ÃŸen: ${blocked_v4} IPv4, ${blocked_v6} IPv6${NC}"
}

##
# FÃ¼gt ein Land zur Blockliste hinzu.
##
add_country_to_blocklist() {
    local country_code="$1"
    
    if [ -z "$country_code" ]; then
        log_error "Bitte einen 2-stelligen LÃ¤ndercode angeben."
        log_info "Verwendung: geoip-manager country add <LÃ„NDERCODE>"
        log_info "Beispiele: geoip-manager country add RU"
        log_info "          geoip-manager country add CN"
        return 1
    fi
    
    # Normalisiere zu GroÃŸbuchstaben
    country_code=$(echo "$country_code" | tr '[:lower:]' '[:upper:]')
    
    # Validiere Format (2 Buchstaben)
    if [[ ! "$country_code" =~ ^[A-Z]{2}$ ]]; then
        log_error "UngÃ¼ltiger LÃ¤ndercode: '$country_code'"
        log_error "Format: Genau 2 GroÃŸbuchstaben (z.B. DE, US, RU)"
        return 1
    fi
    
    print_header "LAND ZUR BLOCKLISTE HINZUFÃœGEN: $country_code"
    
    # PrÃ¼fe ob bereits blockiert
    if [ -f "$COUNTRIES_FILE" ]; then
        local current_countries=$(cat "$COUNTRIES_FILE" 2>/dev/null | tr -d '\n\r')
        if echo "$current_countries" | grep -q "\b$country_code\b"; then
            log_warn "Land '$country_code' ist bereits in der Blockliste."
            return 0
        fi
    fi
    
    # PrÃ¼fe ob es das Heimatland ist
    if [ -f "$HOME_COUNTRY_FILE" ]; then
        local home_country=$(cat "$HOME_COUNTRY_FILE" 2>/dev/null | tr -d '\n\r')
        if [ "$country_code" = "$home_country" ]; then
            log_error "Kann Heimatland '$country_code' nicht blockieren!"
            log_info "Ã„ndere zuerst das Heimatland mit: geoip-manager country home <NEUES_LAND>"
            return 1
        fi
    fi
    
    # FÃ¼ge zur Konfiguration hinzu
    if [ -f "$COUNTRIES_FILE" ] && [ -s "$COUNTRIES_FILE" ]; then
        # Datei existiert und ist nicht leer - hÃ¤nge an
        local current_content=$(cat "$COUNTRIES_FILE" | tr -d '\n\r')
        echo "${current_content}${current_content:+,}${country_code}" > "$COUNTRIES_FILE"
    else
        # Neue Datei oder leer
        echo "$country_code" > "$COUNTRIES_FILE"
    fi
    
    log_ok "Land '$country_code' zur Blockliste hinzugefÃ¼gt."
    
    # Starte automatisches Update
    log_info "Starte automatisches Update der IP-Sets..."
    if "$UPDATE_SCRIPT" >/dev/null 2>&1; then
        local stats=($(get_set_stats))
        log_ok "Update erfolgreich! Neue Set-GrÃ¶ÃŸen: ${stats[2]} IPv4, ${stats[3]} IPv6"
    else
        log_error "Update fehlgeschlagen! FÃ¼hre manuell aus: geoip-manager update"
        return 1
    fi
    
    log_info "ğŸ’¡ Das Land '$country_code' wird nun automatisch blockiert."
}

##
# Entfernt ein Land aus der Blockliste.
##
remove_country_from_blocklist() {
    local country_code="$1"
    
    if [ -z "$country_code" ]; then
        log_error "Bitte einen 2-stelligen LÃ¤ndercode angeben."
        log_info "Verwendung: geoip-manager country remove <LÃ„NDERCODE>"
        return 1
    fi
    
    # Normalisiere zu GroÃŸbuchstaben
    country_code=$(echo "$country_code" | tr '[:lower:]' '[:upper:]')
    
    # Validiere Format
    if [[ ! "$country_code" =~ ^[A-Z]{2}$ ]]; then
        log_error "UngÃ¼ltiger LÃ¤ndercode: '$country_code'"
        return 1
    fi
    
    print_header "LAND AUS BLOCKLISTE ENTFERNEN: $country_code"
    
    # PrÃ¼fe ob Datei existiert
    if [ ! -f "$COUNTRIES_FILE" ]; then
        log_warn "Blockliste-Datei '$COUNTRIES_FILE' nicht gefunden."
        log_info "Keine LÃ¤nder sind derzeit blockiert."
        return 0
    fi
    
    # PrÃ¼fe ob Land in der Liste ist
    local current_countries=$(cat "$COUNTRIES_FILE" 2>/dev/null | tr -d '\n\r')
    if ! echo "$current_countries" | grep -q "\b$country_code\b"; then
        log_warn "Land '$country_code' ist nicht in der Blockliste."
        log_info "Aktuelle Blockliste: $current_countries"
        return 0
    fi
    
    # Entferne das Land aus der Liste
    local new_countries=$(echo "$current_countries" | sed "s/\b$country_code\b//g" | sed 's/,,*/,/g' | sed 's/^,//;s/,$//')
    
    # Schreibe neue Liste
    if [ -n "$new_countries" ]; then
        echo "$new_countries" > "$COUNTRIES_FILE"
        log_ok "Land '$country_code' aus Blockliste entfernt."
    else
        # Liste ist leer geworden
        echo "" > "$COUNTRIES_FILE"
        log_ok "Land '$country_code' entfernt. Blockliste ist jetzt leer."
    fi
    
    # Starte automatisches Update
    log_info "Starte automatisches Update der IP-Sets..."
    if "$UPDATE_SCRIPT" >/dev/null 2>&1; then
        local stats=($(get_set_stats))
        log_ok "Update erfolgreich! Neue Set-GrÃ¶ÃŸen: ${stats[2]} IPv4, ${stats[3]} IPv6"
    else
        log_error "Update fehlgeschlagen! FÃ¼hre manuell aus: geoip-manager update"
        return 1
    fi
    
    log_info "ğŸ’¡ Das Land '$country_code' wird nicht mehr blockiert."
}

##
# Setzt das Heimatland (geschÃ¼tztes Land).
##
set_home_country() {
    local country_code="$1"
    
    if [ -z "$country_code" ]; then
        log_error "Bitte einen 2-stelligen LÃ¤ndercode angeben."
        log_info "Verwendung: geoip-manager country home <LÃ„NDERCODE>"
        log_info "Beispiel: geoip-manager country home DE"
        return 1
    fi
    
    # Normalisiere zu GroÃŸbuchstaben
    country_code=$(echo "$country_code" | tr '[:lower:]' '[:upper:]')
    
    # Validiere Format
    if [[ ! "$country_code" =~ ^[A-Z]{2}$ ]]; then
        log_error "UngÃ¼ltiger LÃ¤ndercode: '$country_code'"
        return 1
    fi
    
    print_header "HEIMATLAND SETZEN: $country_code"
    
    # PrÃ¼fe aktuelles Heimatland
    if [ -f "$HOME_COUNTRY_FILE" ]; then
        local current_home=$(cat "$HOME_COUNTRY_FILE" 2>/dev/null | tr -d '\n\r')
        if [ "$country_code" = "$current_home" ]; then
            log_info "Land '$country_code' ist bereits das Heimatland."
            return 0
        fi
        log_info "Ã„ndere Heimatland von '$current_home' zu '$country_code'"
    fi
    
    # Entferne aus Blockliste falls vorhanden
    if [ -f "$COUNTRIES_FILE" ]; then
        local current_blocked=$(cat "$COUNTRIES_FILE" 2>/dev/null | tr -d '\n\r')
        if echo "$current_blocked" | grep -q "\b$country_code\b"; then
            log_info "Entferne '$country_code' automatisch aus der Blockliste..."
            remove_country_from_blocklist "$country_code" >/dev/null 2>&1
        fi
    fi
    
    # Setze neues Heimatland
    echo "$country_code" > "$HOME_COUNTRY_FILE"
    log_ok "Heimatland auf '$country_code' gesetzt."
    
    # Starte automatisches Update
    log_info "Starte automatisches Update der IP-Sets..."
    if "$UPDATE_SCRIPT" >/dev/null 2>&1; then
        local stats=($(get_set_stats))
        log_ok "Update erfolgreich! Heimatland-Sets: ${stats[0]} IPv4, ${stats[1]} IPv6"
    else
        log_error "Update fehlgeschlagen! FÃ¼hre manuell aus: geoip-manager update"
        return 1
    fi
    
    log_info "ğŸ’¡ Das Land '$country_code' ist jetzt geschÃ¼tzt und wird nie blockiert."
}

##
# Country-Management-Hauptfunktion.
##
handle_country_command() {
    local action="$1"
    local country_code="$2"
    
    case "$action" in
        list)
            show_country_config
            ;;
        add)
            add_country_to_blocklist "$country_code"
            ;;
        remove)
            remove_country_from_blocklist "$country_code"
            ;;
        home)
            set_home_country "$country_code"
            ;;
        *)
            log_error "Unbekannte Country-Aktion: '$action'"
            echo
            log_info "VerfÃ¼gbare Aktionen:"
            log_info "  geoip-manager country list           - Zeigt aktuelle Konfiguration"
            log_info "  geoip-manager country add <CODE>     - FÃ¼gt Land zur Blockliste hinzu"
            log_info "  geoip-manager country remove <CODE>  - Entfernt Land von Blockliste"
            log_info "  geoip-manager country home <CODE>    - Setzt Heimatland"
            return 1
            ;;
    esac
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BENUTZER-KOMMANDOS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

##
# Zeigt einen detaillierten Status-Ãœberblick (KORRIGIERTE VERSION).
##
show_status() {
    print_header "GeoIP-Blocking Status (Set-basiert) v$VERSION"
    
    # Konfiguration anzeigen
    local config_data=$(get_configuration)
    local blocked_countries=$(echo "$config_data" | cut -d'|' -f1)
    local home_country=$(echo "$config_data" | cut -d'|' -f2)
    
    echo -e "${CYAN}Blockierte LÃ¤nder:${NC} $blocked_countries"
    echo -e "${GREEN}Heimatland (geschÃ¼tzt):${NC} $home_country"
    echo
    
    # Service-Status
    echo -e "${BLUE}--- Service & Automatisierung ---${NC}"
    if systemctl is-active --quiet geoip-update.timer 2>/dev/null; then
        local next_run=$(systemctl list-timers geoip-update.timer --no-pager 2>/dev/null | awk 'NR==2 {print $1, $2}' || echo "Unbekannt")
        echo -e "Update-Timer: ${GREEN}âœ… Aktiv${NC} (NÃ¤chster Lauf: $next_run)"
    else
        echo -e "Update-Timer: ${RED}âŒ Inaktiv${NC}"
        log_warn "Timer nicht aktiv! Aktivieren mit: systemctl enable --now geoip-update.timer"
    fi
    
    local last_run=$(journalctl -t geoip-update -n 1 --output=short-precise 2>/dev/null | head -1 | cut -d' ' -f1-3 || echo "Nie")
    echo -e "Letzter Update-Lauf: ${CYAN}$last_run${NC}"
    echo
    
    # NFTables-Status & Set-Inhalte
    echo -e "${BLUE}--- Firewall-Integration & Set-Inhalte ---${NC}"
    local chain_status=$(detect_geoip_chain_status)
    
    case "$chain_status" in
        "missing")
            echo -e "Firewall-Integration: ${RED}âŒ FEHLT${NC}"
            log_error "GeoIP-Chain 'geoip_check' nicht gefunden!"
            log_error "Das GeoIP-System ist nicht korrekt installiert."
            return 1
            ;;
        "unintegrated")
            echo -e "Firewall-Integration: ${YELLOW}âš ï¸  NICHT INTEGRIERT${NC}"
            log_warn "GeoIP-Chain existiert, aber ist nicht in der Firewall aktiv!"
            log_warn "Die jump-Regel fehlt in der input-Chain."
            log_info "LÃ¶sung: Firewall neu laden mit: $NFT_CMD -f /etc/nftables.conf"
            ;;
        "empty_sets")
            echo -e "Firewall-Integration: ${YELLOW}âš ï¸  SETS LEER${NC}"
            log_warn "GeoIP-Chain ist integriert, aber die Sets sind leer oder enthalten zu wenig IPs."
            log_info "LÃ¶sung: Update ausfÃ¼hren mit: geoip-manager update"
            ;;
        "active")
            echo -e "Firewall-Integration: ${GREEN}âœ… AKTIV UND FUNKTIONAL${NC}"
            log_ok "GeoIP-Blocking ist vollstÃ¤ndig aktiviert und einsatzbereit."
            ;;
    esac
    
    # Set-Statistiken
    echo -e "${BLUE}--- IP-Set Statistiken ---${NC}"
    local stats=($(get_set_stats))
    local home_v4=${stats[0]:-0}
    local home_v6=${stats[1]:-0} 
    local blocked_v4=${stats[2]:-0}
    local blocked_v6=${stats[3]:-0}
    
    # Heimatland-Sets
    if [ "$home_v4" -gt 0 ] || [ "$home_v6" -gt 0 ]; then
        echo -e "Heimatland-IPs ($home_country): ${GREEN}$home_v4 IPv4, $home_v6 IPv6${NC}"
    else
        echo -e "Heimatland-IPs ($home_country): ${RED}âŒ Keine IPs geladen${NC}"
        log_error "Heimatland-Sets sind leer! Das ist kritisch."
    fi
    
    # Blockierte Sets
    if [ "$blocked_v4" -gt 0 ] || [ "$blocked_v6" -gt 0 ]; then
        echo -e "Blockierte IPs ($blocked_countries): ${RED}$blocked_v4 IPv4, $blocked_v6 IPv6${NC}"
    else
        echo -e "Blockierte IPs: ${YELLOW}âš ï¸  Keine IPs blockiert${NC}"
        log_warn "Keine blockierten IPs geladen. GeoIP-Blocking ist inaktiv."
    fi
    
    # Allowlist-Statistik (KORRIGIERT - verhindert Syntaxfehler)
    local manual_allowlist_count=0
    if [ -f "$ALLOWLIST_FILE" ]; then
        manual_allowlist_count=$(grep -c '^[^#]' "$ALLOWLIST_FILE" 2>/dev/null | tr -d '\n\r' || echo "0")
    fi
    
    local allowlist_v4_count
    allowlist_v4_count=$($NFT_CMD list set inet filter geoip_allowlist_v4 2>/dev/null | grep -c "^[[:space:]]*[0-9]" | tr -d '\n\r' || echo "0")
    local allowlist_v6_count
    allowlist_v6_count=$($NFT_CMD list set inet filter geoip_allowlist_v6 2>/dev/null | grep -c "::" | tr -d '\n\r' || echo "0")
    
    echo -e "Manuelle Allowlist: ${CYAN}${manual_allowlist_count} persistent, ${allowlist_v4_count} IPv4, ${allowlist_v6_count} IPv6 aktiv${NC}"
    
    # Performance-Info (KORRIGIERT - verhindert Syntaxfehler)
    echo -e "${BLUE}--- Performance & Empfehlungen ---${NC}"
    local total_ips=$(( home_v4 + home_v6 + blocked_v4 + blocked_v6 + allowlist_v4_count + allowlist_v6_count ))
    
    if [ "$total_ips" -gt 5000000 ]; then
        log_warn "Sehr groÃŸe IP-Sets ($total_ips IPs) - kann Performance beeintrÃ¤chtigen."
    elif [ "$total_ips" -gt 1000000 ]; then
        log_info "GroÃŸe IP-Sets ($total_ips IPs) - Performance ist normal auf VPS."
    else
        log_ok "Moderate IP-Set-GrÃ¶ÃŸe ($total_ips IPs) - optimale Performance."
    fi
    
    echo
    echo -e "${BLUE}--- Schnell-Befehle ---${NC}"
    echo -e "Manuelles Update: ${YELLOW}geoip-manager update${NC}"
    echo -e "Traffic-Statistiken: ${YELLOW}geoip-manager hits${NC}"
    echo -e "LÃ¤nder verwalten: ${YELLOW}geoip-manager country list${NC}"
    echo -e "Logs anzeigen: ${YELLOW}geoip-manager logs${NC}"
    
    # Notfall-Befehle nur bei Problemen
    if [ "$chain_status" != "active" ]; then
        echo
        echo -e "${RED}--- Notfall-Befehle ---${NC}"
        echo -e "Firewall neu laden: ${YELLOW}sudo $NFT_CMD -f /etc/nftables.conf${NC}"
        echo -e "GeoIP deaktivieren: ${YELLOW}sudo $NFT_CMD delete rule inet filter input jump geoip_check${NC}"
    fi
}

##
# FÃ¼hrt ein manuelles Update der IP-Listen durch.
##
run_manual_update() {
    print_header "MANUELLES GEOIP-UPDATE"
    
    if [ ! -x "$UPDATE_SCRIPT" ]; then
        log_error "Update-Script '$UPDATE_SCRIPT' nicht gefunden oder nicht ausfÃ¼hrbar!"
        log_info "Installiere das GeoIP-System mit dem Server-Baukasten."
        return 1
    fi
    
    log_info "Starte manuelles Update der GeoIP-Listen..."
    log_info "Dies kann je nach Anzahl der LÃ¤nder 30-60 Sekunden dauern."
    echo
    
    # FÃ¼hre das Update-Script aus
    if "$UPDATE_SCRIPT"; then
        echo
        log_ok "Manuelles Update erfolgreich abgeschlossen!"
        log_info "Neue Set-Statistiken:"
        local stats=($(get_set_stats))
        echo -e "  Heimatland: ${GREEN}${stats[0]} (IPv4), ${stats[1]} (IPv6)${NC}"
        echo -e "  Blockierte: ${RED}${stats[2]} (IPv4), ${stats[3]} (IPv6)${NC}"
    else
        log_error "Update fehlgeschlagen! PrÃ¼fe die Logs mit: journalctl -t geoip-update"
        return 1
    fi
}

##
# Zeigt Traffic-Statistiken (Paket-Counter) der GeoIP-Regeln.
##
show_traffic_hits() {
    print_header "GeoIP Traffic-Statistiken (seit letztem Neustart)"
    
    if ! $NFT_CMD list chain inet filter geoip_check >/dev/null 2>&1; then
        log_error "GeoIP-Chain nicht gefunden! System nicht installiert."
        return 1
    fi
    
    local chain_content
    chain_content=$($NFT_CMD -a list chain inet filter geoip_check 2>/dev/null)
    
    if [ -z "$chain_content" ]; then
        log_warn "GeoIP-Chain ist leer oder nicht erreichbar."
        return 1
    fi
    
    echo -e "${BLUE}Counter-Statistiken der GeoIP-Regeln:${NC}"
    echo
    
    # Extrahiere Counter-Werte basierend auf Kommentaren
    local rules=(
        "Manual-Allow-v4:Manuelle IPv4-Allowlist"
        "Manual-Allow-v6:Manuelle IPv6-Allowlist" 
        "GeoIP-Allow-Home-v4:Heimatland IPv4"
        "GeoIP-Allow-Home-v6:Heimatland IPv6"
        "GeoIP-Block-v4:Blockierte IPv4"
        "GeoIP-Block-v6:Blockierte IPv6"
    )
    
    for rule_info in "${rules[@]}"; do
        local comment=$(echo "$rule_info" | cut -d':' -f1)
        local description=$(echo "$rule_info" | cut -d':' -f2)
        
        local stats=$(echo "$chain_content" | grep "comment \"$comment\"" | awk '{for(i=1;i<=NF;i++) if($i=="counter") {printf "Pakete: %s, Bytes: %s", $(i+2), $(i+4); break}}' || echo "Keine Daten")
        
        local color=$GREEN
        [[ "$comment" =~ Block ]] && color=$RED
        [[ "$comment" =~ Manual ]] && color=$CYAN
        
        printf "%-25s: %b\n" "$description" "${color}${stats}${NC}"
    done
    
    echo
    log_info "ğŸ’¡ Hohe Block-Counter deuten auf viele abgewehrte Angriffe hin."
    log_info "ğŸ’¡ Counter werden bei jedem Neustart zurÃ¼ckgesetzt."
}

##
# Verbesserte IP-Test-Funktion ohne nft trace
##
test_ip_treatment() {
    local ip_to_test="$1"
    
    if [ -z "$ip_to_test" ]; then
        log_error "Bitte eine IP-Adresse zum Testen angeben."
        log_info "Verwendung: geoip-manager test <IP-ADRESSE>"
        return 1
    fi
    
    print_header "IP-BEHANDLUNG TESTEN: $ip_to_test"
    
    # Validiere IP-Format
    if [[ ! "$ip_to_test" =~ ^[0-9.]+$ ]]; then
        log_error "UngÃ¼ltiges IPv4-Format: $ip_to_test"
        return 1
    fi
    
    log_info "Teste Behandlung der IP '$ip_to_test' durch das GeoIP-System..."
    echo
    
    # Test 1: Manuelle Allowlist
    if $NFT_CMD get element inet filter geoip_allowlist_v4 "{ $ip_to_test }" >/dev/null 2>&1; then
        echo -e "${GREEN}âœ… ERLAUBT: IP ist in der manuellen Allowlist${NC}"
        return 0
    fi
    
    # Test 2: Heimatland-Schutz
    if $NFT_CMD get element inet filter geoip_home_v4 "{ $ip_to_test }" >/dev/null 2>&1; then
        echo -e "${GREEN}âœ… ERLAUBT: IP gehÃ¶rt zum geschÃ¼tzten Heimatland${NC}"
        return 0
    fi
    
    # Test 3: Blockierte LÃ¤nder
    if $NFT_CMD get element inet filter geoip_blocked_v4 "{ $ip_to_test }" >/dev/null 2>&1; then
        echo -e "${RED}ğŸš« BLOCKIERT: IP gehÃ¶rt zu einem blockierten Land${NC}"
        return 0
    fi
    
    # Test 4: Nicht in GeoIP-Sets = wird durchgelassen
    echo -e "${CYAN}ğŸ“ DURCHGELASSEN: IP ist in keinem GeoIP-Set (vermutlich erlaubtes Land)${NC}"
    
    echo
    log_info "ğŸ’¡ Ergebnis-Interpretation:"
    log_info "   âœ… ERLAUBT = Verbindung wird akzeptiert"
    log_info "   ğŸš« BLOCKIERT = Verbindung wird verworfen"
    log_info "   ğŸ“ DURCHGELASSEN = Geht weiter zu SSH/ICMP-Regeln"
}

##
# FÃ¼gt eine IP zur manuellen Allowlist hinzu.
##
add_ip_to_allowlist() {
    local ip_to_allow="$1"
    
    if [ -z "$ip_to_allow" ]; then
        log_error "Bitte IP-Adresse oder CIDR-Block fÃ¼r die Allowlist angeben."
        log_info "Verwendung: geoip-manager allow <IP-ADRESSE-ODER-CIDR>"
        log_info "Beispiele: geoip-manager allow 192.168.1.100"
        log_info "          geoip-manager allow 10.0.0.0/24"
        return 1
    fi
    
    print_header "IP ZUR ALLOWLIST HINZUFÃœGEN: $ip_to_allow"
    
    # Validiere IP/CIDR-Format
    if [[ ! "$ip_to_allow" =~ ^[0-9.:a-fA-F/]+$ ]]; then
        log_error "UngÃ¼ltiges IP/CIDR-Format: $ip_to_allow"
        return 1
    fi
    
    # Bestimme Set-Typ (IPv4 oder IPv6)
    local target_set=""
    if [[ "$ip_to_allow" == *":"* ]]; then
        target_set="geoip_allowlist_v6"
        log_info "Erkannt als IPv6-Adresse/Netz"
    else
        target_set="geoip_allowlist_v4"
        log_info "Erkannt als IPv4-Adresse/Netz"
    fi
    
    # FÃ¼ge zur NFTables-Allowlist hinzu
    if $NFT_CMD add element inet filter "$target_set" "{ $ip_to_allow }" 2>/dev/null; then
        log_ok "IP $ip_to_allow erfolgreich zum Set '$target_set' hinzugefÃ¼gt."
    else
        log_error "Fehler beim HinzufÃ¼gen zu NFTables-Set!"
        log_info "PrÃ¼fe IP-Format und ob die Sets existieren."
        return 1
    fi
    
    # Speichere in persistenter Datei
    if ! grep -qxF "$ip_to_allow" "$ALLOWLIST_FILE" 2>/dev/null; then
        echo "$ip_to_allow" >> "$ALLOWLIST_FILE"
        log_ok "IP persistent in '$ALLOWLIST_FILE' gespeichert."
    else
        log_info "IP war bereits in der persistenten Allowlist."
    fi
    
    log_info "ğŸ’¡ Die IP ist nun dauerhaft von GeoIP-Blocking ausgenommen."
    log_info "ğŸ’¡ Entfernen mit: $NFT_CMD delete element inet filter $target_set { $ip_to_allow }"
}

##
# Zeigt die letzten Log-EintrÃ¤ge des GeoIP-Update-Systems.
##
show_logs() {
    local log_count="${1:-50}"
    
    print_header "GEOIP-UPDATE LOGS (letzte $log_count EintrÃ¤ge)"
    
    if ! command -v journalctl >/dev/null 2>&1; then
        log_error "journalctl nicht verfÃ¼gbar!"
        return 1
    fi
    
    log_info "Zeige die letzten $log_count Log-EintrÃ¤ge des GeoIP-Update-Systems..."
    echo
    
    # Zeige Logs vom geoip-update Service
    journalctl -t "geoip-update" -n "$log_count" --no-pager --output=short 2>/dev/null || {
        log_warn "Keine Logs fÃ¼r 'geoip-update' gefunden."
        log_info "MÃ¶glicherweise wurde noch nie ein Update durchgefÃ¼hrt."
        log_info "Starte ein Update mit: geoip-manager update"
    }
}

##
# Zeigt die ausfÃ¼hrliche Hilfe an.
##
show_help() {
    cat << EOF
${BLUE}geoip-manager v$VERSION${NC}
EigenstÃ¤ndiges Management-Tool fÃ¼r das Set-basierte GeoIP-Blocking.

${CYAN}VERWENDUNG:${NC}
  geoip-manager [BEFEHL] [OPTIONEN]

${CYAN}BEFEHLE:${NC}
  status                       - Zeigt Status, Konfiguration und Set-Statistiken
  update                       - Startet manuelles Update der IP-Listen (dauert ~60s)
  hits                         - Zeigt Traffic-Statistiken der GeoIP-Regeln
  test <IP>                    - Simuliert und verfolgt Behandlung einer IP
  allow <IP/CIDR>              - FÃ¼gt IP/Netz zur manuellen Allowlist hinzu
  country list                 - Zeigt aktuelle LÃ¤nder-Konfiguration
  country add <CODE>           - FÃ¼gt Land zur Blockliste hinzu
  country remove <CODE>        - Entfernt Land von Blockliste
  country home <CODE>          - Setzt Heimatland (geschÃ¼tzt)
  logs [Anzahl]                - Zeigt Update-Logs (Standard: 50 EintrÃ¤ge)
  help                         - Zeigt diese ausfÃ¼hrliche Hilfe

${CYAN}BEISPIELE:${NC}
  geoip-manager status                    # Status-Ãœbersicht anzeigen
  geoip-manager update                    # IP-Listen jetzt aktualisieren
  geoip-manager test 8.8.8.8             # Teste Google-DNS
  geoip-manager allow 192.168.1.0/24     # Erlaube lokales Netz
  geoip-manager hits                      # Zeige Angriffs-Statistiken
  geoip-manager country list              # Zeige LÃ¤nder-Konfiguration
  geoip-manager country add RU            # Blockiere Russland
  geoip-manager country remove CN         # Entferne China aus Blockliste
  geoip-manager country home DE           # Setze Deutschland als Heimat
  geoip-manager logs 100                  # Zeige letzte 100 Log-EintrÃ¤ge

${CYAN}VERWALTUNG:${NC}
  systemctl status geoip-update.timer    # Timer-Status prÃ¼fen
  systemctl restart geoip-update.timer   # Timer neu starten
  journalctl -u geoip-update.service     # Service-Logs anzeigen

${CYAN}KONFIGURATION:${NC}
  Blockierte LÃ¤nder: ${YELLOW}$COUNTRIES_FILE${NC}
  Heimatland:        ${YELLOW}$HOME_COUNTRY_FILE${NC}
  Manuelle Allowlist: ${YELLOW}$ALLOWLIST_FILE${NC}

${CYAN}NOTFÃ„LLE:${NC}
  GeoIP komplett deaktivieren:
    $NFT_CMD delete rule inet filter input jump geoip_check
  
  Alle Blockierungen aufheben:
    $NFT_CMD flush set inet filter geoip_blocked_v4
    $NFT_CMD flush set inet filter geoip_blocked_v6

${CYAN}SUPPORT:${NC}
  ğŸ“‹ Repository: https://github.com/TZERO78/Server-Baukasten
  ğŸ› Issues: https://github.com/TZERO78/Server-Baukasten/issues
  ğŸ“– Dokumentation: https://github.com/TZERO78/Server-Baukasten/docs

EOF
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HAUPTFUNKTION (KOMMANDO-ROUTER)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

##
# Hauptfunktion - verarbeitet Benutzer-Befehle.
##
main() {
    # Basis-Checks durchfÃ¼hren
    check_dependencies
    check_geoip_installation
    
    # Kommando verarbeiten
    case "${1:-status}" in
        status)
            show_status
            ;;
        update)
            run_manual_update
            ;;
        hits)
            show_traffic_hits
            ;;
        test)
            test_ip_treatment "$2"
            ;;
        allow)
            add_ip_to_allowlist "$2"
            ;;
        country)
            handle_country_command "$2" "$3"
            ;;
        logs)
            show_logs "${2:-50}"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "Unbekannter Befehl: '$1'"
            echo
            log_info "VerfÃ¼gbare Befehle: status, update, hits, test, allow, country, logs, help"
            log_info "AusfÃ¼hrliche Hilfe: geoip-manager help"
            exit 1
            ;;
    esac
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCRIPT-START
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# FÃ¼hre die Hauptfunktion mit allen Argumenten aus
main "$@"